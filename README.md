# LFM2-ColBERT-350M + Qdrant API

A production-ready stack for multilingual document retrieval: LFM2-ColBERT-350M (`pylate`) + FastAPI + Qdrant, containerized with Docker Compose.

---

## Features

- Sentence/document embedding via `LFM2-ColBERT-350M`
- Storage and retrieval in Qdrant vector DB
- Simple REST API for indexing and search

## Getting Started

### 1. Clone this repo

git clone <REPO_URL>
cd lfm2-colbert-qdrant-api

### 2. Build and Launch

docker compose up --build

FastAPI available at [http://localhost:8000](http://localhost:8000)  
Qdrant available at [http://localhost:6333](http://localhost:6333)

### 3. Example API Usage

**Index a Document**
curl -X POST localhost:8000/index/
-H "Content-Type: application/json"
-d '{"doc_id":"doc1","text":"Example document here."}'

**Search for Documents**
curl -X POST localhost:8000/search/
-H "Content-Type: application/json"
-d '{"query_texts":["search phrase"],"top_k":3}'


## File Structure

- `app.py`: FastAPI server with endpoints
- `requirements.txt`: Python dependencies
- `Dockerfile`: FastAPI app container
- `docker-compose.yml`: Qdrant & API multi-container setup

---

## Notes

- The script stores embeddings with *mean pooling*; for ColBERT-style late interaction or multi-vector search, further adaptation is possible.
- Modify collection settings in `app.py` as needed.

---
---

## API Endpoints

The API provides 8 endpoints for health checking, indexing documents, searching, and OpenAI-compatible embeddings. All endpoints except `/health`, `/docs`, and `/redoc` require authentication.

### GET /health
- **Description**: Health check endpoint that verifies Qdrant connectivity and collection status.
- **Request Body**: None
- **Response**: 
  - `{"status": "ok", "details": {"qdrant_status": "reachable", "collection_points_count": int}}` on success
  - `{"status": "error", "details": {"qdrant_status": "unreachable", "error": str}}` on failure
- **Authentication Requirements**: None
- **Special Notes**: Returns the number of indexed documents in the collection.

### POST /index/
- **Description**: Indexes a single document into the vector database.
- **Request Body**: 
  - `IndexRequest`: `{"doc_id": "string", "text": "string"}`
- **Response**: 
  - `{"message": "Indexed", "id": "string"}`
- **Authentication Requirements**: Required (`X-API-Key` header)
- **Special Notes**: Uses mean pooling for document embeddings.

### POST /search/
- **Description**: Searches for documents similar to the provided query texts.
- **Request Body**: 
  - `QueryRequest`: `{"query_texts": ["string"], "top_k": 3}` (top_k is optional, defaults to 3)
- **Response**: 
  - List of `[{"query": "string", "results": [{"id": "string", "score": float, "payload": {"text": "string"}}]}]`
- **Authentication Requirements**: Required (`X-API-Key` header)
- **Special Notes**: Supports multiple queries in a single request.

### POST /batch_index/
- **Description**: Indexes multiple documents in a single batch operation.
- **Request Body**: 
  - `BatchIndexRequest`: `{"docs": [{"doc_id": "string", "text": "string"}]}` (list of IndexRequest objects)
- **Response**: 
  - `{"success": true, "count": int}`
- **Authentication Requirements**: Required (`X-API-Key` header)
- **Special Notes**: Encodes all texts once for efficiency, then processes individually.

### POST /batch_search/
- **Description**: Performs batch search for multiple queries.
- **Request Body**: 
  - `BatchQueryRequest`: `{"queries": ["string"], "top_k": 3}` (top_k is optional, defaults to 3)
- **Response**: 
  - List of `[{"query": "string", "results": [{"id": "string", "score": float, "payload": {"text": "string"}}]}]`
- **Authentication Requirements**: Required (`X-API-Key` header)
- **Special Notes**: Encodes all queries once for efficiency.

### POST /v1/embeddings
- **Description**: OpenAI-compatible embedding endpoint for generating vector representations.
- **Request Body**: 
  - `OpenAIEmbeddingRequest`: `{"model": "string", "input": "string"}` or `{"model": "string", "inputs": ["string"]}`
- **Response**: 
  - `OpenAIEmbeddingResponse`: `{"object": "list", "data": [{"object": "embedding", "embedding": [float], "index": int}], "model": "string", "usage": {}}`
- **Authentication Requirements**: Required (Bearer token in Authorization header)
- **Special Notes**: Supports single input string or list of strings.

### GET /docs
- **Description**: Interactive API documentation generated by FastAPI (Swagger UI).
- **Request Body**: None
- **Response**: HTML page with interactive API documentation
- **Authentication Requirements**: None
- **Special Notes**: Automatically generated from endpoint definitions.

### GET /redoc
- **Description**: Alternative API documentation generated by FastAPI (ReDoc).
- **Request Body**: None
- **Response**: HTML page with API documentation
- **Authentication Requirements**: None
- **Special Notes**: Automatically generated from endpoint definitions.